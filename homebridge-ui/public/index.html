<!-- Miele@homebridge custom setup UI.
  -- Work in progress. Currently automated setup is disabled. -->

<img src="./miele-homebridge.png"/>

<!-- Setup required. -->
<div id="setupRequired" style="display:none;" class="card card-body">
    <form id="step1">
    <div class="form-group">
        <label for="clientIdInput">Client ID</label>
        <input type="text" class="form-control" id="clientIdInput" required>
    </div>
    <div class="form-group">
        <label for="clientSecretInput">Client Secret</label>
        <input type="text" class="form-control" id="clientSecretInput" required>
    </div>
    <div class="text-center">
        <button id="step1Submit" type="button" class="btn btn-primary">Next</button>
    </div>
    </form>

    <form id="step2" style="display:none;">
    <div class="form-group">
        <label for="clientIdInput">Client ID</label>
        <input type="text" class="form-control" id="clientIdInput" required>
    </div>
    <div class="form-group">
        <label for="clientSecretInput">Client Secret</label>
        <input type="text" class="form-control" id="clientSecretInput" required>
    </div>
    <div class="text-center">
        <button id="step2Submit" type="button" class="btn btn-primary">Next</button>
    </div>
    </form>
</div>

  
  <script>
    (async () => {
      
      // TODO: when no config exists, the showConfigForm doesn't display anything...
      // Get the initial config - this is an array potentially containing multiple config blocks
      const pluginConfig = await homebridge.getPluginConfig();
      await homebridge.updatePluginConfig(pluginConfig);

      console.log("pluginConfig: "+JSON.stringify(pluginConfig));

      const schema = await homebridge.getPluginConfigSchema();

      homebridge.createForm(schema, pluginConfig);


  
      // Get the intial from the config and add it to the form
      //if (!pluginConfig.length) {
      //  document.getElementById('setupRequired').style.display = 'block';
      //} else {
      //  homebridge.showSchemaForm();
      //}
  

/*
      // Step 1 submit handler.
      document.getElementById('step1Submit').addEventListener('click', async () => {
        const clientId = document.getElementById('clientIdInput').value;
        const clientSecret = document.getElementById('clientSecretInput').value;

        // Validate preconditions.
        if (!clientId) {
            homebridge.toast.error('Please enter a valid Client ID as obtained from Miele.', 'Error');
            return;
        }

        if (!clientSecret) {
            homebridge.toast.error('Please enter a valid Client Secret as obtained from Miele.', 'Error');
            return;
        }

        document.getElementById('step1Submit').setAttribute('disabled', 'disabled');

        try {
            homebridge.showSpinner()
            //const response = `https://api.mcs3.miele.com/thirdparty/login?client_id=${clientId}&response_type=code&redirect_uri=http://localhost:8000&state=1`);

            await homebridge.request('/token', { username: "sander" });
            homebridge.hideSpinner()
            // document.getElementById('step1').style.display = 'none';
            // document.getElementById('step2').style.display = 'block';
        } catch (e) {
            homebridge.hideSpinner()
            homebridge.toast.error(e.message, 'Error');
        }

        document.getElementById('step1Submit').removeAttribute('disabled');
      });
*/






/*
      // watch for click events on the getTokenButton
      document.querySelector('#getTokenButton').addEventListener('click', async () => {
        // validate a username was provided
        const username = document.querySelector('#userNameInput').value;
  
        if (!username) {
          // create a error / red toast notification if the required input is not provided.
          homebridge.toast.error('A username must be provided.', 'Error');
          return;
        }
  
        // starting the request, show the loading spinner
        homebridge.showSpinner();
  
        // request a token from the server
        try {
          const response = await homebridge.request('/token', {
            username: username,
          });
  
          // update the token input with the response
          document.querySelector('#tokenInput').value = response.token;
  
          // update the plugin config
          pluginConfig[0].token = response.token;
          homebridge.updatePluginConfig(pluginConfig);
  
          // show a success toast notification
          homebridge.toast.success('Got Token!', 'Success');
        } catch (e) {
          homebridge.toast.error(e.error, e.message);
        } finally {
          // remember to un-hide the spinner
          homebridge.hideSpinner();
        }
      });*/
  
    })();
  
  </script>